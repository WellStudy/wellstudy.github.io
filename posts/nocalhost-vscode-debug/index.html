<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Nocalhost 目前支持 Jetbrains 全系列插件的一键调试。随着 Nocalhost v0.6.9 发布，VSCode 一键调试已支持 Go、Python、Node.js、Java、Ruby、PHP 。
传统调试 远程调试（Remote Debug）一直都是排查问题的重要手段，但在 k8s 环境里调试服务并不是一件简单的事情。传统调试服务都需要以下步骤：
修改镜像（用 Debug 调试器启动的开发镜像）。 kubectl port-forward 转发调试端口到本地。 配置 IDE 连接到调试端口。 调试过程中，每次代码修改到反馈大致需要5分钟（CI/CD)， 调试相对麻烦、编码循环反馈慢、体验不佳。
Nocalhost 调试 使用 Nocalhost 只需简单配置，即可一键启动 Debug ，代码实时同步远端容器，做到秒级编码反馈，大幅提升云原生行业开发效率。
原理 当我们使用 Nocalhost 调试时，VSCode 插件会首先进入 DevMode模式，执行以下操作：
将工作负载的副本数缩减为1。为了在通过Service访问时只访问我们正在开发的应用程序，我们需要缩减副本数为1。
替换容器的镜像为开发镜像。
增加一个 sidecar 容器。在我们编辑的代码时希望更改的代码能快速更新到工作负载中，于是我们增加了 sidecar 来实现代码的同步。
在进入 DevMode 后，插件会执行以下操作：
在工作负载中执行 debug 命令，启动应用及调试器。 自动将远程调试端口转发至本地随机端口。 通过调试协议连接调试端口检测调试器是否就绪。 等待调试器就绪后，插件会自动连接调试端口开始调试。 当使用Nocalhost 开发镜像时 VSCode 插件会自动识别开发语言，启动对应的调试器进行调试。
如果我们自定义了开发镜像，启动Remote Debug时需根据提示选择对应的开发语言。
使用步骤 前置准备 准备一个可用的 Kubernetes 集群 VSCode 1.58+ 安装 Nocalhost VSCode 插件 配置 在调试之前，我们点击需要调试的工作负载右边的 ⚙️ ，进行Debug配置。"><title>使用 Nocalhost VSCode 插件调试 k8s 服务
</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0fd5ea42a66e542531a19d9029e1132d02ecce8360d6392f6e2926cbf4e5d0951924c15ec4f9d26f27cb1b6f78b454e170f933f7a85160ceffb20a6b34f875c1.css integrity="sha512-D9XqQqZuVCUxoZ2QKeETLQLszoNg1jkvbikmy/Tl0JUZJMFexPnSbyfLG294tFThcPkz96hRYM7/sgprNPh1wQ=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><a href=/>首页</a><article><p class=post-meta><time datetime="2022-01-10 00:00:00 +0000 UTC">2022-01-10</time></p><h1>使用 Nocalhost VSCode 插件调试 k8s 服务</h1><p>Nocalhost 目前支持 Jetbrains 全系列插件的一键调试。随着 Nocalhost v0.6.9 发布，VSCode 一键调试已支持 <code>Go</code>、<code>Python</code>、<code>Node.js</code>、<code>Java</code>、<code>Ruby</code>、<code>PHP</code> 。</p><h3 id=传统调试>传统调试</h3><p>远程调试（Remote Debug）一直都是排查问题的重要手段，但在 k8s 环境里调试服务并不是一件简单的事情。传统调试服务都需要以下步骤：</p><ol><li>修改镜像（用 Debug 调试器启动的开发镜像）。</li><li><code>kubectl port-forward</code> 转发调试端口到本地。</li><li>配置 IDE 连接到调试端口。</li></ol><p>调试过程中，每次代码修改到反馈大致需要5分钟（CI/CD)， 调试相对麻烦、编码循环反馈慢、体验不佳。</p><p><img src=./assets/old-debug.jpg alt></p><h3 id=nocalhost-调试>Nocalhost 调试</h3><p>使用 Nocalhost 只需简单配置，即可一键启动 Debug ，代码实时同步远端容器，做到<strong>秒级</strong>编码反馈，大幅提升云原生行业开发效率。</p><p><img src=./assets/new-debug.jpg alt></p><h4 id=原理>原理</h4><p>当我们使用 Nocalhost 调试时，VSCode 插件会首先进入 <code>DevMode</code>模式，执行以下操作：</p><ol><li><p>将工作负载的副本数缩减为1。为了在通过<code>Service</code>访问时只访问我们正在开发的应用程序，我们需要缩减副本数为1。</p></li><li><p>替换容器的镜像为开发镜像。</p></li><li><p>增加一个 sidecar 容器。在我们编辑的代码时希望更改的代码能快速更新到工作负载中，于是我们增加了 sidecar 来实现代码的同步。</p></li></ol><p>在进入 <code>DevMode</code> 后，插件会执行以下操作：</p><ol><li>在工作负载中执行 debug 命令，启动应用及调试器。</li><li>自动将远程调试端口转发至本地随机端口。</li><li>通过调试协议连接调试端口检测调试器是否就绪。</li><li>等待调试器就绪后，插件会自动连接调试端口开始调试。</li></ol><blockquote><p>当使用Nocalhost 开发镜像时 VSCode 插件会自动识别开发语言，启动对应的调试器进行调试。</p><p>如果我们自定义了开发镜像，启动<code>Remote Debug</code>时需根据提示选择对应的开发语言。</p></blockquote><h3 id=使用步骤>使用步骤</h3><h4 id=前置准备>前置准备</h4><ul><li>准备一个可用的 Kubernetes 集群</li><li>VSCode 1.58+</li><li>安装 Nocalhost VSCode 插件</li></ul><h4 id=配置>配置</h4><p>在调试之前，我们点击需要调试的工作负载右边的 ⚙️ ，进行Debug配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span> - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authors</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dev</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nocalhost-docker.pkg.coding.net/nocalhost/dev-images/golang:latest</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>./debug.sh</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>remoteDebugPort</span>: <span style=color:#ae81ff>9009</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>配置说明：</p><ul><li><p><code>dev.image</code>：开发镜像，远程调试依赖容器中调试器（如 go的Delve、Python 的 debugpy、Ruby 的 ruby-debug-ide、PHP 的 xdebug），所以在调试前需要替换容器镜像为带有调试器的开发镜像。Nocalhost 提供以下镜像,并提供<a href=https://github.com/nocalhost/dev-container>源码</a>,并提供在线配置工具 <a href=https://nocalhost.dev/tools/>Tools</a>。</p><p><img src=./assets/tools.jpg alt=tools></p></li><li><p><code>dev.debug.remoteDebugPort</code>：调试器端口，调试会对端口执行端口转发，以便连接调试器。</p></li><li><p><code>dev.command.debug</code>：debug 启动命令，需按照您使用的语言调试器进行配置,并且调试器端口需与<code>dev.debug.remoteDebugPort</code>保持一致，各语言调试器配置如下：</p><ul><li>Node.js 使用 <code>--inspect=&lt;remoteDebugPort></code> 启动 Node.js 应用。</li><li>Python 使用 <code>debugpy</code> 启动 Python 应用。</li><li>Go 使用 <code>dlv debug</code>启动 Go 应用。</li><li>Java 使用<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,remoteDebugPort=,quiet=y</code>选项来启动 Java应用。</li><li>Ruby 使用<code>rdebug-ide</code>启动Ruby应用。</li><li>PHP 使用<code>xdebug</code>实现远程调试，启动命令无需更改。</li></ul></li></ul><p>debug 启动示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># node</span>
</span></span><span style=display:flex><span>node --inspect<span style=color:#f92672>=</span>&lt;remoteDebugPort&gt; index.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># go</span>
</span></span><span style=display:flex><span>dlv debug --headless --log --listen :&lt;remoteDebugPort&gt; app.go
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># java</span>
</span></span><span style=display:flex><span>java -agentlib:jdwp<span style=color:#f92672>=</span>transport<span style=color:#f92672>=</span>dt_socket,server<span style=color:#f92672>=</span>y,suspend<span style=color:#f92672>=</span>n,address<span style=color:#f92672>=</span>&lt;remoteDebugPort&gt;,quiet<span style=color:#f92672>=</span>y -jar app.jar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ruby</span>
</span></span><span style=display:flex><span>rdebug-ide -h 0.0.0.0 -p &lt;remoteDebugPort&gt; -- app.rb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># python</span>
</span></span><span style=display:flex><span>python -m debugpy --listen &lt;remoteDebugPort&gt; --wait-for-client app.py
</span></span></code></pre></div><blockquote><p>为了能快速体验远程调试，您也可以在插件上选择ns点击🚀在弹出框中选择 <code>Deploy Demo</code>安装 <code>Demo</code>应用，安装完成后，即可选择要调试的服务直接开始远程调试。</p></blockquote><h4 id=开始调试>开始调试</h4><p>右键点击 <code>Remote Debug</code>，选择源码目录后开始等待调试器就绪。(首次使用会自动安装依赖插件,需重启后再次点击 <code>Remote Debug</code>开始远程调试)。</p><p><img src=./assets/debug.gif alt=debug></p><p>调试启动后会生成 Nocalhost Debug 配置，后续可直接通过 <code>VSCode Debug</code> 直接启动远程调试。</p></article><script src=https://beaudar.lipk.org/client.js repo=zhangjian10/zhangjian10.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></main><footer><a href=https://beian.miit.gov.cn/ target=_blank>粤ICP备2023151330</a></footer></body></html>